### Variables
@baseUrl = https://localhost:8443
@contentType = application/json

###
# IMPORTANT: Passwords are plain text (NOT base64 encoded)
# Password requirements: min 8 chars with uppercase, lowercase, and number
#
# For HTTPS testing with self-signed certificate:
# - IntelliJ will ask to accept certificate
# - Or use @baseUrl = http://localhost:8080 for non-SSL testing
###

### Register a new user
POST {{baseUrl}}/api/auth/register
Content-Type: {{contentType}}

{
  "username": "johndoe",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john.doe@example.com",
  "password": "SecurePass123!"
}

> {%
  client.test("Register successful", function () {
    client.assert(response.status === 201, "Response status is not 201");
    if (response.body) {
      client.assert(response.body.accessToken, "No access token in response");
      client.global.set("authToken", response.body.accessToken);
    }
  });
%}

### Register another user
POST {{baseUrl}}/api/auth/register
Content-Type: {{contentType}}

{
  "username": "janedoe",
  "firstName": "Jane",
  "lastName": "Doe",
  "email": "jane.doe@example.com",
  "password": "AdminPass456!"
}

> {%
  client.test("Register successful", function () {
    client.assert(response.status === 201, "Response status is not 201");
    if (response.body && response.body.accessToken) {
      client.global.set("authToken", response.body.accessToken);
    }
  });
%}

### Login with first user
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "username": "johndoe",
  "password": "SecurePass123!"
}

> {%
  client.test("Login successful", function () {
    client.assert(response.status === 200, "Response status is not 200");
    if (response.body) {
      client.assert(response.body.accessToken, "No access token in response");
      client.global.set("authToken", response.body.accessToken);
    }
  });
%}

### Login with second user
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "username": "janedoe",
  "password": "AdminPass456!"
}

> {%
  client.test("Login successful", function () {
    client.assert(response.status === 200, "Response status is not 200");
    if (response.body && response.body.accessToken) {
      client.global.set("authToken", response.body.accessToken);
    }
  });
%}

### Test with invalid credentials (should fail)
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "username": "johndoe",
  "password": "WrongPassword123!"
}

> {%
  client.test("Login should fail", function () {
    client.assert(response.status === 401, "Expected unauthorized status");
  });
%}

### Test duplicate username registration (should fail)
POST {{baseUrl}}/api/auth/register
Content-Type: {{contentType}}

{
  "username": "johndoe",
  "firstName": "Another",
  "lastName": "User",
  "email": "another@example.com",
  "password": "TestPassword123"
}

> {%
  client.test("Registration should fail with duplicate username", function () {
    client.assert(response.status === 409, "Expected conflict status");
  });
%}

### Test duplicate email registration (should fail)
POST {{baseUrl}}/api/auth/register
Content-Type: {{contentType}}

{
  "username": "newusername",
  "firstName": "Another",
  "lastName": "User",
  "email": "john.doe@example.com",
  "password": "AnotherPass456!"
}

> {%
  client.test("Registration should fail with duplicate email", function () {
    client.assert(response.status === 409, "Expected conflict status");
  });
%}

### Test with missing required fields (should fail)
POST {{baseUrl}}/api/auth/register
Content-Type: {{contentType}}

{
  "username": "incomplete",
  "email": "incomplete@example.com"
}

> {%
  client.test("Registration should fail with missing fields", function () {
    client.assert(response.status === 400, "Expected bad request status");
  });
%}

### Test login with non-existent user (should fail)
POST {{baseUrl}}/api/auth/login
Content-Type: {{contentType}}

{
  "username": "nonexistent",
  "password": "SomePassword123!"
}

> {%
  client.test("Login should fail with non-existent user", function () {
    client.assert(response.status === 401, "Expected unauthorized status");
  });
%}

###
# Password examples used in this file:
# - "SecurePass123!" - Valid password for johndoe
# - "AdminPass456!" - Valid password for janedoe
# - "WrongPassword123!" - Invalid password for testing
# - "TestPassword123" - Password for duplicate testing
# - "AnotherPass456!" - Password for duplicate email testing
###

###
# Protected Endpoints - Require JWT Token
###

### Get current user profile (requires JWT token)
GET {{baseUrl}}/api/auth/me
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
  client.test("Get current user successful", function () {
    client.assert(response.status === 200, "Response status is not 200");
    if (response.body) {
      client.assert(response.body.username, "No username in response");
      client.assert(response.body.email, "No email in response");
      client.log("User: " + response.body.username);
    }
  });
%}

### Refresh access token using refresh token
POST {{baseUrl}}/api/auth/refresh
Content-Type: {{contentType}}

{
  "refreshToken": "PASTE_YOUR_REFRESH_TOKEN_HERE"
}

> {%
  client.test("Refresh token", function () {
    if (response.status === 200 && response.body && response.body.accessToken) {
      client.global.set("authToken", response.body.accessToken);
      client.log("Token refreshed successfully");
    } else {
      client.log("Refresh failed - use refresh token from login/register response");
    }
  });
%}

### Logout user (requires JWT token)
POST {{baseUrl}}/api/auth/logout
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
  client.test("Logout successful", function () {
    client.assert(response.status === 200, "Response status is not 200");
    client.log("User logged out - token should be discarded on client side");
  });
%}

### Test /me endpoint without token (should fail with 401)
GET {{baseUrl}}/api/auth/me
Content-Type: {{contentType}}

> {%
  client.test("Request without token should fail", function () {
    client.assert(response.status === 401, "Expected unauthorized status");
  });
%}

